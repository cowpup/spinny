<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Spinning Pok√©mon Card</title>
    <style>
      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        align-items: center;
        background-color: black;
      }
      canvas {
        display: block;
      }
      #upload-container {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 10;
        background: rgba(255, 255, 255, 0.9);
        padding: 10px;
        border-radius: 8px;
      }
      .slider-container {
        display: flex;
        align-items: center;
        gap: 5px;
        margin: 5px 0;
      }
      .slider-container input[type=number] {
        width: 50px;
      }
      #progressBar {
        position: absolute;
        top: 60px;
        right: 10px;
        width: 200px;
        height: 10px;
        background-color: #ddd;
        z-index: 10;
        display: none;
      }
      #progressBarFill {
        height: 100%;
        background-color: #4caf50;
        width: 0%;
      }
    </style>
    <script src="https://unpkg.com/three@0.148.0/build/three.min.js"></script>
  </head>
  <body>
    <div id="upload-container">
      <label>Front Image: <input type="file" id="frontInput" accept="image/*"></label><br>
      <label>Back Image: <input type="file" id="backInput" accept="image/*"></label><br>
      <label>Background Image: <input type="file" id="bgInput" accept="image/*"></label><br>
      <button id="submitBtn">Submit</button><br>

      <div class="slider-container">
        <label for="adjustX">Adjust Horizontal (X):</label>
        <input type="range" id="adjustX" min="-5" max="5" step="0.1">
        <input type="number" id="adjustXVal">
      </div>
      <div class="slider-container">
        <label for="adjustY">Adjust Vertical (Y):</label>
        <input type="range" id="adjustY" min="-5" max="5" step="0.1">
        <input type="number" id="adjustYVal">
      </div>
      <div class="slider-container">
        <label for="adjustPitch">Adjust Pitch (Z):</label>
        <input type="range" id="adjustPitch" min="-1.5" max="1.5" step="0.05">
        <input type="number" id="adjustPitchVal">
      </div>
      <div class="slider-container">
        <label for="rotationSpeed">Rotate Speed:</label>
        <input type="range" id="rotationSpeed" min="0.001" max="0.1" step="0.001">
        <input type="number" id="rotationSpeedVal">
      </div>
      <div class="slider-container">
        <label for="scale">Scale:</label>
        <input type="range" id="scale" min="0.1" max="2" step="0.01">
        <input type="number" id="scaleVal">
      </div>
      <div class="slider-container">
        <label for="bgScale">Background Scale:</label>
        <input type="range" id="bgScale" min="0.1" max="3" step="0.01">
        <input type="number" id="bgScaleVal">
      </div>
    </div>

    <div id="progressBar"><div id="progressBarFill"></div></div>
    <button id="exportBtn" style="position:absolute; top:10px; right:10px; z-index:10;">Export MP4</button>

    <script>
      let rotationSpeed = parseFloat(localStorage.getItem('rotationSpeed') || 0.0085);
      let scale = parseFloat(localStorage.getItem('scale') || 0.9);
      let bgScale = parseFloat(localStorage.getItem('bgScale') || 1);
      let adjustX = parseFloat(localStorage.getItem('adjustX') || 0);
      let adjustY = parseFloat(localStorage.getItem('adjustY') || 0.3);
      let adjustPitch = parseFloat(localStorage.getItem('adjustPitch') || 0);

      document.getElementById('adjustX').value = adjustX;
      document.getElementById('adjustXVal').value = adjustX;
      document.getElementById('adjustY').value = adjustY;
      document.getElementById('adjustYVal').value = adjustY;
      document.getElementById('adjustPitch').value = adjustPitch;
      document.getElementById('adjustPitchVal').value = adjustPitch;
      document.getElementById('rotationSpeed').value = rotationSpeed;
      document.getElementById('rotationSpeedVal').value = rotationSpeed;
      document.getElementById('scale').value = scale;
      document.getElementById('scaleVal').value = scale;
      document.getElementById('bgScale').value = bgScale;
      document.getElementById('bgScaleVal').value = bgScale;

      // Sync sliders and save to localStorage
      const controls = ["adjustX", "adjustY", "adjustPitch", "rotationSpeed", "scale", "bgScale"];
      controls.forEach(control => {
        const range = document.getElementById(control);
        const num = document.getElementById(control + 'Val');
        range.addEventListener('input', () => {
          num.value = range.value;
          localStorage.setItem(control, range.value);
        });
        num.addEventListener('input', () => {
          range.value = num.value;
          localStorage.setItem(control, num.value);
        });
      });

      document.getElementById('exportBtn').addEventListener('click', () => {
        const canvas = document.querySelector('canvas');
        const stream = canvas.captureStream(30);
        const recorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
        const chunks = [];

        const rotationSpeedVal = parseFloat(document.getElementById('rotationSpeed').value);
        const totalFrames = Math.round((Math.PI * 2) / rotationSpeedVal);

        const progressBar = document.getElementById('progressBar');
        const progressBarFill = document.getElementById('progressBarFill');
        progressBar.style.display = 'block';

        recorder.ondataavailable = e => chunks.push(e.data);
        recorder.onstop = () => {
          const blob = new Blob(chunks, { type: 'video/webm' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'spinning_card.mp4';
          a.click();
          progressBar.style.display = 'none';
          progressBarFill.style.width = '0%';
        };

        recorder.start();

        let framesCaptured = 0;
        const captureInterval = setInterval(() => {
          if (!cardMesh) return;
          cardMesh.rotation.y += rotationSpeedVal;
          renderer.render(scene, camera);
          framesCaptured++;
          progressBarFill.style.width = (framesCaptured / totalFrames) * 100 + '%';
          if (framesCaptured >= totalFrames) {
            clearInterval(captureInterval);
            recorder.stop();
          }
        }, 1000 / 30);
      });
    </script>
  </body>
</html>
